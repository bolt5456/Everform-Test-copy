{% comment %}
  Related Products Section
  Shows recommended products based on current product
  Uses product recommendations API or manual selection
{% endcomment %}

<div class="related-products section">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="related-products__heading text-center">{{ section.settings.heading }}</h2>
    {% endif %}

    {%- comment -%}Use Shopify Product Recommendations API{%- endcomment -%}
    {% if section.settings.use_recommendations %}
      <div class="related-products__grid" data-product-recommendations="{{ product.id }}">
        {%- comment -%}Recommendations will be loaded here via AJAX{%- endcomment -%}
        <div class="related-products__loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    {% else %}
      {%- comment -%}Manual product selection via metafield or blocks{%- endcomment -%}
      {% if product.metafields.custom.related_products %}
        <div class="related-products__grid">
          {% for related_product_id in product.metafields.custom.related_products.value limit: section.settings.products_to_show %}
            {% assign related_product = all_products[related_product_id] %}
            {% if related_product %}
              <div class="related-products__item">
                {% render 'product-card',
                  product: related_product,
                  show_vendor: section.settings.show_vendor,
                  image_ratio: section.settings.image_ratio,
                  lazy_load: true
                %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% elsif section.blocks.size > 0 %}
        {%- comment -%}Use blocks for manual product selection{%- endcomment -%}
        <div class="related-products__grid">
          {% for block in section.blocks limit: section.settings.products_to_show %}
            {% if block.type == 'product' and block.settings.product != blank %}
              <div class="related-products__item" {{ block.shopify_attributes }}>
                {% render 'product-card',
                  product: block.settings.product,
                  show_vendor: section.settings.show_vendor,
                  image_ratio: section.settings.image_ratio,
                  lazy_load: true
                %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        {%- comment -%}Fallback: Show products from same collection{%- endcomment -%}
        {% if collection and collection.products.size > 1 %}
          <div class="related-products__grid">
            {% for related_product in collection.products limit: section.settings.products_to_show %}
              {% unless related_product.id == product.id %}
                <div class="related-products__item">
                  {% render 'product-card',
                    product: related_product,
                    show_vendor: section.settings.show_vendor,
                    image_ratio: section.settings.image_ratio,
                    lazy_load: true
                  %}
                </div>
              {% endunless %}
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    {% endif %}

    {% if section.settings.view_all_text != blank and section.settings.view_all_url != blank %}
      <div class="related-products__cta text-center">
        <a href="{{ section.settings.view_all_url }}" class="btn btn--secondary">
          {{ section.settings.view_all_text }}
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Load product recommendations via AJAX
  (function() {
    const recommendationsContainer = document.querySelector('[data-product-recommendations]');

    if (recommendationsContainer && {{ section.settings.use_recommendations | json }}) {
      const productId = recommendationsContainer.dataset.productRecommendations;
      const limit = {{ section.settings.products_to_show | default: 4 }};

      fetch(`/recommendations/products.json?product_id=${productId}&limit=${limit}`)
        .then(response => response.json())
        .then(data => {
          if (data.products && data.products.length > 0) {
            // Clear loading state
            recommendationsContainer.innerHTML = '';

            // Render product cards
            data.products.forEach(product => {
              const productCard = createProductCard(product);
              recommendationsContainer.appendChild(productCard);
            });
          } else {
            // No recommendations, hide section
            recommendationsContainer.closest('.related-products').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading recommendations:', error);
          recommendationsContainer.closest('.related-products').style.display = 'none';
        });
    }

    function createProductCard(product) {
      const item = document.createElement('div');
      item.className = 'related-products__item';

      const vatRate = {{ settings.vat_rate_percentage | default: 20 }};
      const showVat = {{ settings.enable_vat_pricing | json }};
      const priceWithVat = Math.round(product.price * (1 + vatRate / 100));

      let priceHTML = '';
      if (showVat) {
        priceHTML = `
          <span class="product-card__price-ex-vat">${formatMoney(product.price)}</span>
          <span class="product-card__price-inc-vat small">${formatMoney(priceWithVat)} {{ settings.vat_inc_label }}</span>
        `;
      } else {
        priceHTML = `<span class="price__amount">${formatMoney(product.price)}</span>`;
      }

      item.innerHTML = `
        <article class="product-card">
          <a href="${product.url}" class="product-card__link">
            <div class="product-card__image-wrapper aspect-ratio aspect-ratio--{{ section.settings.image_ratio }}">
              ${product.featured_image ?
                `<img src="${product.featured_image}" alt="${product.title}" loading="lazy" class="product-card__image">` :
                '<div class="product-card__placeholder"></div>'
              }
            </div>
            <div class="product-card__content">
              <h3 class="product-card__title">${product.title}</h3>
              <div class="product-card__price">${priceHTML}</div>
            </div>
          </a>
        </article>
      `;

      return item;
    }
  })();
</script>

<style>
  .related-products {
    padding: var(--spacing-4xl) 0;
    background-color: var(--color-off-white);
  }

  .related-products__heading {
    margin-bottom: var(--spacing-2xl);
  }

  .related-products__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
  }

  @media (min-width: 768px) {
    .related-products__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-xl);
    }
  }

  @media (min-width: 1024px) {
    .related-products__grid {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-2xl);
    }
  }

  .related-products__loading {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: var(--spacing-4xl) 0;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spinner 0.6s linear infinite;
  }

  @keyframes spinner {
    to { transform: rotate(360deg); }
  }

  .related-products__cta {
    margin-top: var(--spacing-2xl);
  }
</style>

{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "checkbox",
      "id": "use_recommendations",
      "label": "Use Shopify Product Recommendations",
      "default": true,
      "info": "Uses Shopify's AI to recommend related products. Fallback to manual selection if disabled."
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to Show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show Vendor",
      "default": false
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image Aspect Ratio",
      "options": [
        {
          "value": "4-5",
          "label": "Portrait (4:5)"
        },
        {
          "value": "1-1",
          "label": "Square (1:1)"
        },
        {
          "value": "4-3",
          "label": "Landscape (4:3)"
        }
      ],
      "default": "4-5"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Button Text",
      "default": "View All Products"
    },
    {
      "type": "url",
      "id": "view_all_url",
      "label": "View All Button URL",
      "default": "/collections/all"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Related Products"
    }
  ]
}
{% endschema %}
